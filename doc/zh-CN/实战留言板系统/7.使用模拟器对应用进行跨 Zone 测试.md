# 模拟器的工作原理介绍

# 使用模拟器进行调试

# 更多的常用CYFS调试技巧



## 深入探究 Service 启动程序

- 完整代码见 src/service/entry/app_startup.ts

Service 启动程序的入口为 main 函数，主要完成 3 个步骤：

1. 开启 Service 日志。
2. 打开并等待 Stack 上线。
3. 在 Stack 上注册路由模块。

## 开启 Service 日志

日志可以让我们快速的发现并定位问题，对解决线上问题十分有帮助。不同的操作系统，应用日志的存储路径略有不同；

- mac: ~/Library/cyfs/log/app/<app_name>
- windows: C:\cyfs\log\app\<app_name>
- linux: /cyfs/log/app/<app_name>

基于 CYFS SDK 开启 Service 日志非常简单，代码如下：

```typescript
import * as cyfs from "cyfs-sdk";

cyfs.clog.enable_file_log({
	name: APP_NAME,
	dir: cyfs.get_app_log_dir(APP_NAME),
});
```

## 打开并等待 Stack 上线

通过引入 cyfs_helper 中的 waitStackOOD 方法，我们可以很方便实现打开并等待 Stack 上线，代码如下：

```typescript
import { waitStackOOD } from "src/common/cyfs_helper/stack_wraper";

const waitR = await waitStackOOD(DEC_ID);
if (waitR.err) {
	console.error(`service start failed when wait stack online, err: ${waitR}.`);
	return;
}
```

## 在 Stack 上注册路由

使用 addRouters 方法来批量注册路由，提高开发效率。addRouters 方法中通过遍历封装了全部路由模块的`routers`对象，完成批量注册的功能。在每一轮循环中，主要完成 2 个任务：

1. 为请求路径 req_path 动态设置 access 权限，这里我们调用 cyfs.AccessString.full 方法把该请求路径的读、写和 call 权限都打开。
2. 使用 add_post_object_handler 方法将路由模块挂载到 Stack 上的指定请求路径下。

addRouters 代码如下：

```typescript
import * as cyfs from "cyfs-sdk";

export type RouterArray = Array<{
	reqPath: string;
	router: postRouterHandle;
}>;

async function addRouters(
	stack: cyfs.SharedCyfsStack,
	routers: RouterArray
): Promise<void> {
	for (const routerObj of routers) {
		const access = new cyfs.AccessString(0);
		access.set_group_permissions(
			cyfs.AccessGroup.CurrentZone,
			cyfs.AccessPermissions.WirteAndCall
		);
		access.set_group_permissions(
			cyfs.AccessGroup.CurrentDevice,
			cyfs.AccessPermissions.WirteAndCall
		);
		access.set_group_permissions(
			cyfs.AccessGroup.OwnerDec,
			cyfs.AccessPermissions.WirteAndCall
		);
		// 打开全部权限
		// const access = cyfs.AccessString.full();
		// 为路径设置 access 权限
		const ra = await stack
			.root_state_meta_stub()
			.add_access(
				cyfs.GlobalStatePathAccessItem.new(routerObj.reqPath, access)
			);
		if (ra.err) {
			console.error(`path (${routerObj.reqPath}) add access error: ${ra}`);
			continue;
		}
		console.log("add access successed: ", ra.unwrap());
		const handleId = `post-${routerObj.reqPath}`;
		// 挂载路由模块到指定请求路径
		const r = await stack
			.router_handlers()
			.add_post_object_handler(
				cyfs.RouterHandlerChain.Handler,
				handleId,
				1,
				undefined,
				routerObj.reqPath,
				cyfs.RouterHandlerAction.Pass,
				new PostRouterReqPathRouterHandler(routerObj)
			);

		if (r.err) {
			console.error(`add post handler (${handleId}) failed, err: ${r}`);
		} else {
			console.info(`add post handler (${handleId}) success.`);
		}
	}
}
```

